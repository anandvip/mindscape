<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mindscape Co-Creator</title>
    <style>
        /* 1. Global Styles & Theming */
        :root {
            --bg-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --surface-color: rgba(45, 55, 72, 0.9);
            --surface-border: rgba(226, 232, 240, 0.15);
            --primary-color: #667eea;
            --glow-color: rgba(102, 126, 234, 0.5);
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --danger-color: #f56565;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gradient);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* 2. Layout & Main Sections */
        .container { max-width: 100%; margin: 0 auto; }
        .header { text-align: center; padding: 20px; background: rgba(0,0,0,0.2); backdrop-filter: blur(10px); }
        .header h1 { font-size: 1.8rem; margin-bottom: 5px; color: var(--text-primary); }
        .time-display { text-align: center; padding: 10px; font-size: 0.9rem; opacity: 0.7; }
        .section { padding: 0 20px; margin-bottom: 30px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .section-title { font-size: 1.3rem; font-weight: 600; }
        .full-screen-view {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-gradient);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        /* 3. Cards & Carousels */
        .scroll-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scroll-behavior: smooth; padding-bottom: 15px; scrollbar-width: none; }
        .scroll-container::-webkit-scrollbar { display: none; }
        .card {
            flex-shrink: 0; width: calc(100vw - 60px); margin-right: 15px;
            scroll-snap-align: center; background: var(--surface-color); backdrop-filter: blur(5px);
            border-radius: 12px; padding: 15px; border: 1px solid var(--surface-border);
            transition: all 0.3s ease;
        }
        .card:last-child { margin-right: 0; }
        .pattern-card.focused { box-shadow: 0 0 20px var(--glow-color); border-color: var(--primary-color); }
        .encounter-card { border-left: 4px solid var(--surface-border); }
        .encounter-card.focused-pattern { border-left-color: var(--primary-color); background: rgba(102, 126, 234, 0.1); }
        .encounter-card.flagged { border-left-color: var(--warning-color); }

        /* 4. Buttons & UI Elements */
        .btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: rgba(255, 255, 255, 0.1); color: var(--text-primary); border: 1px solid var(--surface-border); }
        .form-section { background: var(--surface-color); border-radius: 12px; padding: 20px; border: 1px solid var(--surface-border); }
        input[type="text"], textarea {
            width: 100%; padding: 12px; border: 1px solid var(--surface-border); border-radius: 8px; font-size: 1rem;
            background: rgba(0, 0, 0, 0.3); color: var(--text-primary); margin-bottom: 15px; font-family: inherit;
        }
        textarea { resize: vertical; min-height: 100px; }
        input[type="text"]:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px var(--glow-color); }

        /* 5. Specific Component Styles */
        .pattern-actions, .encounter-actions { display: flex; gap: 8px; margin-top: 15px; }
        .journal-preview { font-size: 0.8rem; font-style: italic; opacity: 0.7; margin-top: 10px; border-left: 2px solid var(--primary-color); padding-left: 8px; }
        .report-card { margin-bottom: 20px; padding: 15px; border-radius: 8px; background: rgba(0,0,0,0.2); }
        .report-card h3 { color: var(--primary-color); margin-bottom: 10px; }

    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Mindscape Co-Creator</h1>
            <p>Your co-creative workspace for the self.</p>
        </header>
        <div class="time-display" id="time-display"></div>

        <main id="main-content">
            <!-- Add Pattern -->
            <section class="section">
                <div class="form-section">
                    <input type="text" id="pattern-input" placeholder="What new thought is present?" maxlength="100">
                    <button class="btn btn-primary" id="add-pattern-btn">Begin Tracking</button>
                </div>
            </section>

            <!-- Active Patterns -->
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Active Patterns</h2>
                    <div>
                        <button class="btn btn-secondary btn-small" id="toggle-archive-btn">Retired</button>
                        <button class="btn btn-secondary btn-small" id="toggle-palette-btn">Palette</button>
                    </div>
                </div>
                <div class="scroll-container" id="patterns-container"></div>
            </section>

            <!-- Recent Encounters -->
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Recent Encounters</h2>
                    <button class="btn btn-secondary btn-small" id="generate-report-btn">Daily Report</button>
                </div>
                <div class="scroll-container" id="encounters-container"></div>
            </section>
        </main>

        <!-- Full-Screen Views (hidden by default) -->
        <div class="full-screen-view" id="archive-view">
            <div class="section-header">
                <h2 class="section-title">Retired Patterns</h2>
                <button class="btn btn-secondary" id="close-archive-btn">Close</button>
            </div>
            <div id="retired-patterns-container"></div>
        </div>

        <div class="full-screen-view" id="palette-view">
            <div class="section-header">
                <h2 class="section-title">Your Emotional Palette</h2>
                <button class="btn btn-secondary" id="close-palette-btn">Close</button>
            </div>
            <div class="form-section">
                <h3>Add a New Emotion</h3>
                <input type="text" id="emotion-name-input" placeholder="Name (e.g., Sonder, Anxiety)">
                <input type="color" id="emotion-color-input" value="#888888">
                <button class="btn btn-primary" id="add-emotion-btn">Add to Palette</button>
            </div>
            <div id="user-emotions-container"></div>
        </div>

        <div class="full-screen-view" id="report-view">
            <div class="section-header">
                <h2 class="section-title">Daily Reflection Report</h2>
                <button class="btn btn-secondary" id="close-report-btn">Close</button>
            </div>
            <div id="report-content-container" class="form-section"></div>
        </div>

        <!-- Modals for focused tasks -->
        <div class="full-screen-view" id="review-modal"></div>
        <div class="full-screen-view" id="journal-modal"></div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // -----------------------------------------------------------------------------
    //  1. STATE & CONSTANTS
    // -----------------------------------------------------------------------------
    let state = {
        patterns: [],
        encounters: [],
        userEmotions: [],
        reflections: [],
        ui: { focusedPatternId: null }
    };
    const CONTEXT_OPTIONS = ['Work', 'Home', 'Commute', 'Social', 'Media', 'Alone'];
    const elements = { /* All document.getElementById calls are consolidated here */ };

    // -----------------------------------------------------------------------------
    //  2. CORE LOGIC (ACTIONS) - Modify the state
    // -----------------------------------------------------------------------------
    const actions = {
        addPattern(text) {
            if (!text) return;
            state.patterns.push({
                id: Date.now(), text: text.trim(), originalText: text.trim(),
                createdAt: new Date().toISOString(), status: 'active', insights: []
            });
            saveAndRender();
        },
        logEncounter(patternId, context, emotionId) {
            state.encounters.push({
                id: Date.now(), patternId, timestamp: new Date().toISOString(),
                context, emotionId, journal: '', resources: [], flagged: false
            });
            saveAndRender();
        },
        addEmotion(name, color) {
            if (!name) return;
            state.userEmotions.push({ id: Date.now(), name: name.trim(), color });
            saveAndRender();
        },
        deleteEmotion(id) {
            state.userEmotions = state.userEmotions.filter(e => e.id !== id);
            saveAndRender();
        },
        startReview(patternId) {
            renderReviewModal(patternId);
            elements.reviewModal.style.display = 'block';
        },
        evolvePattern(patternId, newText) {
            const pattern = state.patterns.find(p => p.id === patternId);
            if (pattern && newText) {
                pattern.text = newText;
                saveAndRender();
            }
        },
        retirePattern(patternId) {
            const pattern = state.patterns.find(p => p.id === patternId);
            if (pattern) {
                pattern.status = 'retired';
                saveAndRender();
            }
        },
        reactivatePattern(patternId) {
            const pattern = state.patterns.find(p => p.id === patternId);
            if (pattern) {
                pattern.status = 'active';
                saveAndRender();
            }
        },
        toggleFlag(encounterId) {
            const encounter = state.encounters.find(e => e.id === encounterId);
            if(encounter) encounter.flagged = !encounter.flagged;
            saveAndRender();
        },
        saveJournal(encounterId, text) {
            const encounter = state.encounters.find(e => e.id === encounterId);
            if(encounter) encounter.journal = text;
            saveAndRender();
        },
        // ... and so on for other state modifications
    };

    // -----------------------------------------------------------------------------
    //  3. RENDER LOGIC - Read the state and update the DOM
    // -----------------------------------------------------------------------------
    function render() {
        renderPatterns();
        renderEncounters();
        renderPalette();
        renderArchive();
    }
    
    function renderPatterns() {
        const activePatterns = state.patterns.filter(p => p.status === 'active');
        elements.patternsContainer.innerHTML = activePatterns.map(p => `
            <div class="card pattern-card ${state.ui.focusedPatternId === p.id ? 'focused' : ''}" data-pattern-id="${p.id}">
                <p style="font-weight: 600;">${p.text}</p>
                <div class="pattern-actions">
                    <button class="btn btn-primary btn-small js-log-btn">Log</button>
                    <button class="btn btn-secondary btn-small js-review-btn">Review</button>
                </div>
            </div>
        `).join('') || '<div class="card"><p>Add a pattern to begin.</p></div>';
    }

    function renderEncounters() {
        let encountersToRender = [...state.encounters].reverse();
        // Sorting logic for focused pattern...
        elements.encountersContainer.innerHTML = encountersToRender.map(e => {
            const pattern = state.patterns.find(p => p.id === e.patternId);
            const emotion = state.userEmotions.find(em => em.id === e.emotionId);
            return `
                <div class="card encounter-card ${state.ui.focusedPatternId === e.patternId ? 'focused-pattern' : ''} ${e.flagged ? 'flagged' : ''}" data-encounter-id="${e.id}">
                    <p><strong>${pattern?.text || 'Retired Pattern'}</strong></p>
                    <small>${new Date(e.timestamp).toLocaleString()}</small>
                    ${e.journal ? `<p class="journal-preview">${e.journal.substring(0, 100)}...</p>` : ''}
                    <div class="encounter-actions">
                        <button class="btn btn-secondary btn-small js-journal-btn">Journal</button>
                        <button class="btn btn-secondary btn-small js-flag-btn">${e.flagged ? '★ Unflag' : '☆ Flag'}</button>
                    </div>
                </div>
            `;
        }).join('') || '<div class="card"><p>No encounters logged yet.</p></div>';
    }
    
    function renderPalette() {
        elements.userEmotionsContainer.innerHTML = state.userEmotions.map(e => `
            <div class="card">
                <span style="border-left: 4px solid ${e.color}; padding-left: 8px;">${e.name}</span>
                <button class="js-delete-emotion-btn" data-id="${e.id}" style="float: right; color: var(--danger-color);">X</button>
            </div>
        `).join('');
    }

    function renderArchive() {
        const retiredPatterns = state.patterns.filter(p => p.status === 'retired');
        elements.retiredPatternsContainer.innerHTML = retiredPatterns.map(p => `
            <div class="card">
                <p><strong>${p.text}</strong> (Retired)</p>
                <small>Original: "${p.originalText}"</small>
                <div class="pattern-actions">
                    <button class="btn btn-primary btn-small js-reactivate-btn" data-id="${p.id}">Reactivate</button>
                </div>
            </div>
        `).join('') || '<div class="card"><p>No patterns retired yet.</p></div>';
    }
    
    function renderReviewModal(patternId) {
        const pattern = state.patterns.find(p => p.id === patternId);
        // Generates the full HTML for the review modal and injects it into elements.reviewModal
        // ... (includes inputs for evolving, buttons for retiring, etc.)
    }

    function renderJournalModal(encounterId) {
        const encounter = state.encounters.find(e => e.id === encounterId);
        // Generates HTML for the journal modal and injects it
        // ... (includes textarea, resource inputs, etc.)
    }
    
    function renderReport() {
        // Generates the guided report HTML
        let reportHTML = `<div class="report-card"><h3>...</h3>...</div>`;
        elements.reportContentContainer.innerHTML = reportHTML;
        elements.reportView.style.display = 'block';
    }

    // -----------------------------------------------------------------------------
    //  4. EVENT LISTENERS - Wire up the UI to the actions
    // -----------------------------------------------------------------------------
    function setupEventListeners() {
        document.body.addEventListener('click', e => {
            // Event delegation for all dynamically created buttons
            if (e.target.matches('.js-log-btn')) {
                const patternId = e.target.closest('.pattern-card').dataset.patternId;
                // Here you would open a logging modal with context and custom emotions
            }
            if (e.target.matches('.js-review-btn')) {
                const patternId = e.target.closest('.pattern-card').dataset.patternId;
                actions.startReview(Number(patternId));
            }
            if (e.target.matches('.js-journal-btn')) {
                const encounterId = e.target.closest('.encounter-card').dataset.encounterId;
                renderJournalModal(Number(encounterId)); // Render and show the journal
                elements.journalModal.style.display = 'block';
            }
            // ... and so on for every other button
        });

        // Listeners for top-level buttons to toggle full-screen views
        elements.togglePaletteBtn.addEventListener('click', () => {
            elements.paletteView.style.display = 'block';
        });
        elements.closePaletteBtn.addEventListener('click', () => {
            elements.paletteView.style.display = 'none';
        });
        // ... similar listeners for Archive and Report views
    }

    // -----------------------------------------------------------------------------
    //  5. DATA & INITIALIZATION
    // -----------------------------------------------------------------------------
    function saveAndRender() {
        localStorage.setItem('mindscape-co-creator-data', JSON.stringify(state));
        render();
    }
    function loadState() {
        const savedState = localStorage.getItem('mindscape-co-creator-data');
        if (savedState) {
            state = JSON.parse(savedState);
            // Default any new properties if loading old data
            if (!state.userEmotions) state.userEmotions = [];
        }
    }
    function init() {
        // Consolidate all element lookups into the elements object for performance
        const allElementIds = [
            'time-display', 'main-content', 'pattern-input', 'add-pattern-btn',
            'patterns-container', 'encounters-container', 'archive-view',
            'retired-patterns-container', 'toggle-archive-btn', 'close-archive-btn',
            'palette-view', 'toggle-palette-btn', 'close-palette-btn', 'emotion-name-input',
            'emotion-color-input', 'add-emotion-btn', 'user-emotions-container',
            'report-view', 'generate-report-btn', 'close-report-btn', 'report-content-container',
            'review-modal', 'journal-modal'
        ];
        allElementIds.forEach(id => {
            const camelCaseId = id.replace(/-./g, x => x[1].toUpperCase());
            elements[camelCaseId] = document.getElementById(id);
        });

        loadState();
        setupEventListeners();
        render(); // Initial render
        setInterval(() => {
            elements.timeDisplay.textContent = new Date().toLocaleString();
        }, 1000);
    }

    init();
});
</script>
</body>
</html>
